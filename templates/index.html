<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Opti-Ruta Sky | PoliHacks</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        #map { height: 500px; border-radius: 8px; }
        .card { border-radius: 10px; }
        .form-control-sm { margin-bottom: 5px; }
    </style>
</head>
<body class="bg-light">

    <nav class="navbar navbar-dark bg-dark shadow-sm mb-4">
        <div class="container-fluid">
            <a class="navbar-brand ms-2" href="#">‚úàÔ∏è Opti-Ruta Sky</a>
            <span class="navbar-text text-white-50">Simulaci√≥n Matem√°tica | Wolfram Engine</span>
        </div>
    </nav>

    <div class="container-fluid">

        <div id="alerta-banner" class="alert alert-danger text-center fw-bold fs-5 shadow hidden" role="alert" style="display:none;">
            üö® ¬°ALERTA CR√çTICA! Simulaci√≥n proyecta conflicto en ruta. (ElevenLabs Audio Placeholder)
        </div>

        <div class="row">
            
            <div class="col-md-4">
                
                <div class="card shadow mb-4">
                    <div class="card-header bg-dark text-white fw-bold">
                        ‚öôÔ∏è Optimizaci√≥n de Ruta
                    </div>
                    <div class="card-body">
                        <form id="optimization-form">
                            <h6 class="mt-2">Origen (Lat, Lon):</h6>
                            <input type="text" id="origen_lat" class="form-control form-control-sm" placeholder="Latitud (ej: 19.43)" required>
                            <input type="text" id="origen_lon" class="form-control form-control-sm mb-3" placeholder="Longitud (ej: -99.13)" required>

                            <h6>Destino (Lat, Lon):</h6>
                            <input type="text" id="destino_lat" class="form-control form-control-sm" placeholder="Latitud (ej: 20.00)" required>
                            <input type="text" id="destino_lon" class="form-control form-control-sm mb-3" placeholder="Longitud (ej: -99.90)" required>
                            
                            <h6>Restricciones (Separadas por coma):</h6>
                            <textarea id="restricciones" class="form-control form-control-sm mb-4" rows="2" placeholder="Ej: 19.6,-99.2; 19.8,-99.5"></textarea>

                            <button type="submit" class="btn btn-primary w-100 fw-bold">Calcular Ruta √ìptima</button>
                        </form>
                    </div>
                </div>

                <div class="card shadow mb-4">
                    <div class="card-header bg-secondary text-white fw-bold">
                        üß† An√°lisis de Riesgo (Gemini)
                    </div>
                    <div class="card-body">
                        <p class="small text-muted">Explicabilidad del Modelo:</p>
                        <p id="gemini-analysis">Esperando resultado...</p>
                        <canvas id="analysisChart"></canvas>
                    </div>
                </div>

            </div>
            
            <div class="col-md-8">
                <div class="card shadow mb-4">
                    <div class="card-header bg-success text-white fw-bold">
                        üó∫Ô∏è Visualizaci√≥n Interactiva (Wolfram Engine)
                    </div>
                    <div class="card-body">
                        <div id="map" class="mb-3"></div>
                        <p class="mt-2">Distancia Optimizada: <span id="ruta-km" class="text-primary fw-bold">---</span></p>
                        <p class="mt-1">Estado Wolfram: <span id="status-wolfram" class="text-success fw-bold">Conectado</span></p>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Chart.js (necesario para los gr√°ficos) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script>
        const API_URL = "/api/optimize-route";
        
        // Inicializaci√≥n del Mapa Leaflet (Centrado en CDMX)
        const map = L.map('map').setView([19.5, -99.5], 9);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        let mapLayer = null; // Variable global para guardar la ruta dibujada

        // Inicializaci√≥n de la Gr√°fica (Placeholder) ‚Äî defensivo
        let analysisChart = null;
        try {
            const ctx = document.getElementById('analysisChart').getContext('2d');
            analysisChart = new Chart(ctx, {
                type: 'bar',
                data: { 
                    labels: ['Probabilidad Riesgo', 'Probabilidad √âxito'], 
                    datasets: [{ 
                        label: 'An√°lisis de Incertidumbre', 
                        data: [0, 0],
                        backgroundColor: ['rgba(255, 99, 132, 0.5)', 'rgba(75, 192, 192, 0.5)'],
                    }] 
                },
                options: {
                    responsive: true,
                    scales: { y: { beginAtZero: true, max: 100 } },
                    plugins: { legend: { display: false } }
                }
            });
        } catch (e) {
            console.warn('Chart.js no disponible o fallo al crear gr√°fico:', e);
            analysisChart = null;
        }


        // FUNCI√ìN DE ENV√çO DE DATOS
        document.getElementById('optimization-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // 1. Recolecci√≥n de datos
            const origen = [
                parseFloat(document.getElementById('origen_lat').value),
                parseFloat(document.getElementById('origen_lon').value)
            ];
            const destino = [
                parseFloat(document.getElementById('destino_lat').value),
                parseFloat(document.getElementById('destino_lon').value)
            ];
            
            // Convierte restricciones de texto (ej: 19.6,-99.2; 19.8,-99.5) a un array de arrays
            const restriccionesTexto = document.getElementById('restricciones').value.split(';').map(s => {
                const parts = s.trim().split(',');
                if (parts.length === 2) {
                    return [parseFloat(parts[0]), parseFloat(parts[1])];
                }
                return null;
            }).filter(item => item !== null);

            const payload = {
                origen: origen,
                destino: destino,
                restricciones: restriccionesTexto
            };

            document.getElementById('ruta-km').innerText = 'Calculando...';
            document.getElementById('status-wolfram').innerText = 'EJECUTANDO';
            
            // 2. Env√≠o a la API de Flask
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();
                
                // Manejo de Errores de Conexi√≥n o Servidor
                if (response.status !== 200 || data.error) {
                    document.getElementById('ruta-km').innerText = 'ERROR';
                    document.getElementById('status-wolfram').innerText = 'FALLO CR√çTICO';
                    document.getElementById('gemini-analysis').innerText = data.error || 'Error desconocido en el servidor.';
                    document.getElementById('alerta-banner').style.display = 'block';
                    return;
                }

                // 3. Procesamiento de Resultados
                document.getElementById('status-wolfram').innerText = 'COMPLETADO';
                document.getElementById('ruta-km').innerText = `${data.ruta_km || 'N/A'} KM`;
                
                // Muestra la alerta cr√≠tica (ElevenLabs)
                const banner = document.getElementById('alerta-banner');
                if (data.is_critical_alert) {
                    banner.style.display = 'block';
                    // Aqu√≠ ir√≠a el c√≥digo para reproducir el audio de ElevenLabs
                } else {
                    banner.style.display = 'none';
                }

                // 4. Actualizar Elementos Visuales
                updateMap(data.ruta_coordenadas);
                updateChart(data.analisis_simulacion);
                document.getElementById('gemini-analysis').innerText = data.analisis_ia_texto || 'An√°lisis de IA pendiente...';


            } catch (error) {
                console.error("Error de red:", error);
                document.getElementById('ruta-km').innerText = 'ERROR DE RED';
                document.getElementById('status-wolfram').innerText = 'DESCONECTADO';
            }
        });

        // FUNCI√ìN PARA DIBUJAR LA RUTA EN LEAFLET
        function updateMap(ruta_coordenadas) {
            if (!ruta_coordenadas || !ruta_coordenadas.length) return;

            // 1. Limpiar capa anterior
            if (mapLayer) {
                map.removeLayer(mapLayer);
            }

                // La ruta optimizada debe ser un array de objetos {lat, lon}
                const latlngs = ruta_coordenadas.map(p => [p.lat, p.lon]);
            
            mapLayer = L.polyline(latlngs, {color: 'blue', weight: 4}).addTo(map);
            map.fitBounds(mapLayer.getBounds()); // Centra el mapa en la nueva ruta
        }

        // FUNCI√ìN PARA ACTUALIZAR GR√ÅFICA (T-C2)
        function updateChart(analisis) {
            // Ejemplo de actualizaci√≥n de la gr√°fica de Monte Carlo
            if (!analysisChart) return; // Chart no inicializado
            if (analisis && analisis.riesgo_alto !== undefined) {
                analysisChart.data.datasets[0].data = [analisis.riesgo_alto, analisis.riesgo_exito];
                analysisChart.update();
            }
        }
        
    </script>
</body>
</html>